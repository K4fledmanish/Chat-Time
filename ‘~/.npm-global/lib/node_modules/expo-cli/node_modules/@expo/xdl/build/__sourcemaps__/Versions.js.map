{"version":3,"sources":["Versions.ts"],"names":["versionsAsync","options","api","ApiV2Client","versionCache","Cacher","getAsync","path","join","__dirname","getenv","boolish","skipCache","clearAsync","sdkVersionsAsync","sdkVersions","setVersionsAsync","value","user","UserManager","getCurrentUserAsync","clientForUser","secret","process","env","EXPO_VERSIONS_SECRET","Error","postAsync","releasedSdkVersionsAsync","data","_sdkVersionString","releaseNoteUrl","beta","gteSdkVersion","expJson","sdkVersion","semver","gte","e","XDLError","lteSdkVersion","lte","parseSdkVersionFromTag","tag","startsWith","substring","newestReleasedSdkVersionAsync","betaOptInEnabled","result","highestMajorVersion","version","Object","entries","hasReleaseNotes","isBeta","major","newestSdkVersionAsync","oldestSupportedMajorVersionAsync","supportedVersions","v","isDeprecated","versionNumbers","keys","map","Math","min","facebookReactNativeVersionsAsync","facebookReactNativeVersions","Set","values","facebookReactNativeVersion","filter","Array","from","facebookReactNativeVersionToExpoVersionAsync","outerFacebookReactNativeVersion","valid","currentSdkVersion","minor","gt","canTurtleBuildSdkVersion","platform","getSdkVersionsSupportedByTurtle","supportedVersionsForPlatform","indexOf"],"mappings":";;;;;;;;;;;;;;;;;;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAuCO,eAAeA,aAAf,CAA6BC,OAA7B,EAAmF;AACxF,QAAMC,GAAG,GAAG,KAAIC,eAAJ,GAAZ;AACA,QAAMC,YAAY,GAAG,KAAIC,iBAAJ,EACnB,MAAMH,GAAG,CAACI,QAAJ,CAAa,iBAAb,CADa,EAEnB,eAFmB,EAGnB,CAHmB,EAInBC,gBAAKC,IAAL,CAAUC,SAAV,EAAqB,yBAArB,CAJmB,CAArB,CAFwF,CASxF;;AACA,MAAIC,kBAAOC,OAAP,CAAe,WAAf,EAA4B,KAA5B,MAAsCV,OAAtC,aAAsCA,OAAtC,uBAAsCA,OAAO,CAAEW,SAA/C,CAAJ,EAA8D;AAC5DR,IAAAA,YAAY,CAACS,UAAb;AACD;;AAED,SAAO,MAAMT,YAAY,CAACE,QAAb,EAAb;AACD;;AAEM,eAAeQ,gBAAf,GAAwD;AAC7D,QAAM;AAAEC,IAAAA;AAAF,MAAkB,MAAMf,aAAa,EAA3C;AACA,SAAOe,WAAP;AACD;;AAEM,eAAeC,gBAAf,CAAgCC,KAAhC,EAA4C;AACjD,QAAMC,IAAI,GAAG,MAAMC,gBAAYC,mBAAZ,EAAnB;;AACA,QAAMlB,GAAG,GAAGC,gBAAYkB,aAAZ,CAA0BH,IAA1B,CAAZ;;AACA,QAAMI,MAAM,GAAGC,OAAO,CAACC,GAAR,CAAYC,oBAA3B;AACA,MAAI,CAACH,MAAL,EACE,MAAM,IAAII,KAAJ,CACJ,kFADI,CAAN;AAGF,QAAMxB,GAAG,CAACyB,SAAJ,CAAc,iBAAd,EAAiC;AACrCV,IAAAA,KAAK,EAAEA,KAD8B;AAErCK,IAAAA;AAFqC,GAAjC,CAAN;AAID,C,CAED;AACA;AACA;;;AACO,eAAeM,wBAAf,GAAgE;AACrE,QAAMb,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AACA,SAAO,uBACLC,WADK,EAEL,CAACc,IAAD,EAAOC,iBAAP,KACE,CAAC,CAACD,IAAI,CAACE,cAAP,IAA0BrB,kBAAOC,OAAP,CAAe,WAAf,EAA4B,KAA5B,KAAsCkB,IAAI,CAACG,IAHlE,CAAP;AAKD;;AAEM,SAASC,aAAT,CACLC,OADK,EAELC,UAFK,EAGI;AACT,MAAI,CAACD,OAAO,CAACC,UAAb,EAAyB;AACvB,WAAO,KAAP;AACD;;AAED,MAAID,OAAO,CAACC,UAAR,KAAuB,aAA3B,EAA0C;AACxC,WAAO,IAAP;AACD;;AAED,MAAI;AACF,WAAOC,kBAAOC,GAAP,CAAWH,OAAO,CAACC,UAAnB,EAA+BA,UAA/B,CAAP;AACD,GAFD,CAEE,OAAOG,CAAP,EAAU;AACV,UAAM,KAAIC,mBAAJ,EACJ,iBADI,EAEH,GAAEL,OAAO,CAACC,UAAW,uDAFlB,CAAN;AAID;AACF;;AAEM,SAASK,aAAT,CACLN,OADK,EAELC,UAFK,EAGI;AACT,MAAI,CAACD,OAAO,CAACC,UAAb,EAAyB;AACvB,WAAO,KAAP;AACD;;AAED,MAAID,OAAO,CAACC,UAAR,KAAuB,aAA3B,EAA0C;AACxC,WAAO,KAAP;AACD;;AAED,MAAI;AACF,WAAOC,kBAAOK,GAAP,CAAWP,OAAO,CAACC,UAAnB,EAA+BA,UAA/B,CAAP;AACD,GAFD,CAEE,OAAOG,CAAP,EAAU;AACV,UAAM,KAAIC,mBAAJ,EACJ,iBADI,EAEH,GAAEL,OAAO,CAACC,UAAW,uDAFlB,CAAN;AAID;AACF;;AAEM,SAASO,sBAAT,CAAgCC,GAAhC,EAAqD;AAC1D,MAAIA,GAAG,CAACC,UAAJ,CAAe,MAAf,CAAJ,EAA4B;AAC1B,WAAOD,GAAG,CAACE,SAAJ,CAAc,CAAd,CAAP;AACD;;AAED,SAAOF,GAAP;AACD,C,CAED;AACA;AACA;;;AACO,eAAeG,6BAAf,GAGJ;AACD,QAAMC,gBAAgB,GAAGrC,kBAAOC,OAAP,CAAe,WAAf,EAA4B,KAA5B,CAAzB;;AACA,QAAMI,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AAEA,MAAIkC,MAAM,GAAG,IAAb;AACA,MAAIC,mBAAmB,GAAG,OAA1B;;AAEA,OAAK,MAAM,CAACC,OAAD,EAAUrB,IAAV,CAAX,IAA8BsB,MAAM,CAACC,OAAP,CAAerC,WAAf,CAA9B,EAA2D;AACzD,UAAMsC,eAAe,GAAG,CAAC,CAACxB,IAAI,CAACE,cAA/B;AACA,UAAMuB,MAAM,GAAG,CAAC,CAACzB,IAAI,CAACG,IAAtB;;AAEA,QACEI,kBAAOmB,KAAP,CAAaL,OAAb,IAAwBd,kBAAOmB,KAAP,CAAaN,mBAAb,CAAxB,KACCI,eAAe,IAAKC,MAAM,IAAIP,gBAD/B,CADF,EAGE;AACAE,MAAAA,mBAAmB,GAAGC,OAAtB;AACAF,MAAAA,MAAM,GAAGnB,IAAT;AACD;AACF;;AACD,SAAO;AACLqB,IAAAA,OAAO,EAAED,mBADJ;AAELpB,IAAAA,IAAI,EAAEmB;AAFD,GAAP;AAID;AAED;;;;;AAGO,eAAeQ,qBAAf,GAGJ;AACD,QAAMzC,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AACA,MAAIkC,MAAM,GAAG,IAAb;AACA,MAAIC,mBAAmB,GAAG,OAA1B;;AACA,OAAK,MAAM,CAACC,OAAD,EAAUrB,IAAV,CAAX,IAA8BsB,MAAM,CAACC,OAAP,CAAerC,WAAf,CAA9B,EAA2D;AACzD,QAAIqB,kBAAOmB,KAAP,CAAaL,OAAb,IAAwBd,kBAAOmB,KAAP,CAAaN,mBAAb,CAA5B,EAA+D;AAC7DA,MAAAA,mBAAmB,GAAGC,OAAtB;AACAF,MAAAA,MAAM,GAAGnB,IAAT;AACD;AACF;;AACD,SAAO;AACLqB,IAAAA,OAAO,EAAED,mBADJ;AAELpB,IAAAA,IAAI,EAAEmB;AAFD,GAAP;AAID;;AAEM,eAAeS,gCAAf,GAAmE;AACxE,QAAM1C,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AACA,QAAM4C,iBAAiB,GAAG,uBAAO3C,WAAP,EAAoB4C,CAAC,IAAI,CAACA,CAAC,CAACC,YAA5B,CAA1B;AACA,QAAMC,cAAc,GAAGV,MAAM,CAACW,IAAP,CAAYJ,iBAAZ,EAA+BK,GAA/B,CAAmCb,OAAO,IAAId,kBAAOmB,KAAP,CAAaL,OAAb,CAA9C,CAAvB;AACA,SAAOc,IAAI,CAACC,GAAL,CAAS,GAAGJ,cAAZ,CAAP;AACD;;AAEM,eAAeK,gCAAf,GAAqE;AAC1E,QAAMnD,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AACA,QAAMqD,2BAA2B,GAAG,IAAIC,GAAJ,CAClCjB,MAAM,CAACkB,MAAP,CAActD,WAAd,EACGgD,GADH,CACOlC,IAAI,IAAIA,IAAI,CAACyC,0BADpB,EAEGC,MAFH,CAEUrB,OAAO,IAAIA,OAFrB,CADkC,CAApC;AAKA,SAAOsB,KAAK,CAACC,IAAN,CAAWN,2BAAX,CAAP;AACD;;AAEM,eAAeO,4CAAf,CACLC,+BADK,EAEmB;AACxB,MAAI,CAACvC,kBAAOwC,KAAP,CAAaD,+BAAb,CAAL,EAAoD;AAClD,UAAM,KAAIpC,mBAAJ,EACJ,iBADI,EAEH,GAAEoC,+BAAgC,uDAF/B,CAAN;AAID;;AAED,QAAM5D,WAAW,GAAG,MAAMD,gBAAgB,EAA1C;AACA,MAAI+D,iBAAgC,GAAG,IAAvC;;AAEA,OAAK,MAAM,CAAC3B,OAAD,EAAU;AAAEoB,IAAAA;AAAF,GAAV,CAAX,IAAwDnB,MAAM,CAACC,OAAP,CAAerC,WAAf,CAAxD,EAAqF;AACnF,QACEqB,kBAAOmB,KAAP,CAAaoB,+BAAb,MAAkDvC,kBAAOmB,KAAP,CAAae,0BAAb,CAAlD,IACAlC,kBAAO0C,KAAP,CAAaH,+BAAb,MAAkDvC,kBAAO0C,KAAP,CAAaR,0BAAb,CADlD,KAEC,CAACO,iBAAD,IAAsBzC,kBAAO2C,EAAP,CAAU7B,OAAV,EAAmB2B,iBAAnB,CAFvB,CADF,EAIE;AACAA,MAAAA,iBAAiB,GAAG3B,OAApB;AACD;AACF;;AAED,SAAO2B,iBAAP;AACD;;AAEM,eAAeG,wBAAf,CACL7C,UADK,EAEL8C,QAFK,EAGa;AAAA;;AAClB,MAAI9C,UAAU,KAAK,aAAnB,EAAkC;AAChC,WAAO,IAAP;AACD;;AAED,MAAIC,kBAAOwC,KAAP,CAAazC,UAAb,KAA4B,IAAhC,EAAsC;AACpC,UAAM,KAAII,mBAAJ,EACJ,iBADI,EAEH,IAAGJ,UAAW,wDAFX,CAAN;AAID;;AAED,QAAMuB,iBAAiB,GAAG,MAAMwB,+BAA+B,EAA/D;AACA,QAAMC,4BAAsC,4BAAGzB,iBAAiB,CAACuB,QAAD,CAApB,yEAAkC,EAA9E;AACA,SAAOE,4BAA4B,CAACC,OAA7B,CAAqCjD,UAArC,MAAqD,CAAC,CAA7D;AACD;;AAED,eAAe+C,+BAAf,GAA6E;AAC3E,QAAMhF,GAAG,GAAG,KAAIC,eAAJ,GAAZ;AACA,SAAO,MAAMD,GAAG,CAACI,QAAJ,CAAa,uCAAb,CAAb;AACD","sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport getenv from 'getenv';\nimport pickBy from 'lodash/pickBy';\nimport path from 'path';\nimport semver from 'semver';\n\nimport ApiV2Client from './ApiV2';\nimport UserManager from './User';\nimport XDLError from './XDLError';\nimport { Cacher } from './tools/FsCache';\n\nexport type SDKVersion = {\n  androidExpoViewUrl?: string;\n  expoReactNativeTag: string;\n  /* deprecated */ exponentReactNativeTag?: string;\n  expokitNpmPackage?: string;\n  facebookReactNativeVersion: string;\n  facebookReactVersion?: string;\n  iosExpoViewUrl?: string;\n  /* deprecated */ iosExponentViewUrl?: string;\n  iosVersion?: string;\n  isDeprecated?: boolean;\n  packagesToInstallWhenEjecting?: { [name: string]: string };\n  releaseNoteUrl?: string;\n  iosClientUrl?: string;\n  iosClientVersion?: string;\n  androidClientUrl?: string;\n  androidClientVersion?: string;\n  relatedPackages?: { [name: string]: string };\n  beta?: boolean;\n};\n\nexport type SDKVersions = { [version: string]: SDKVersion };\ntype TurtleSDKVersions = { android: string[]; ios: string[] };\ntype TurtleSDKVersionsOld = { android: string; ios: string };\n\ntype Versions = {\n  androidUrl: string;\n  androidVersion: string;\n  iosUrl: string;\n  iosVersion: string;\n  sdkVersions: SDKVersions;\n  /* deprecated */ starterApps: unknown;\n  /* deprecated */ templates: unknown[];\n  /* deprecated */ templatesv2: unknown[];\n  turtleSdkVersions: TurtleSDKVersionsOld;\n};\n\nexport async function versionsAsync(options?: { skipCache?: boolean }): Promise<Versions> {\n  const api = new ApiV2Client();\n  const versionCache = new Cacher(\n    () => api.getAsync('versions/latest'),\n    'versions.json',\n    0,\n    path.join(__dirname, '../caches/versions.json')\n  );\n\n  // Clear cache when opting in to beta because things can change quickly in beta\n  if (getenv.boolish('EXPO_BETA', false) || options?.skipCache) {\n    versionCache.clearAsync();\n  }\n\n  return await versionCache.getAsync();\n}\n\nexport async function sdkVersionsAsync(): Promise<SDKVersions> {\n  const { sdkVersions } = await versionsAsync();\n  return sdkVersions;\n}\n\nexport async function setVersionsAsync(value: any) {\n  const user = await UserManager.getCurrentUserAsync();\n  const api = ApiV2Client.clientForUser(user);\n  const secret = process.env.EXPO_VERSIONS_SECRET;\n  if (!secret)\n    throw new Error(\n      'Versions.setVersionsAsync: EXPO_VERSIONS_SECRET environment variable is required'\n    );\n  await api.postAsync('versions/update', {\n    value: value as JSONObject,\n    secret,\n  });\n}\n\n// NOTE(brentvatne): it is possible for an unreleased version to be published to\n// the versions endpoint, but in some cases we only want to list out released\n// versions\nexport async function releasedSdkVersionsAsync(): Promise<SDKVersions> {\n  const sdkVersions = await sdkVersionsAsync();\n  return pickBy(\n    sdkVersions,\n    (data, _sdkVersionString) =>\n      !!data.releaseNoteUrl || (getenv.boolish('EXPO_BETA', false) && data.beta)\n  );\n}\n\nexport function gteSdkVersion(\n  expJson: Pick<ExpoConfig, 'sdkVersion'>,\n  sdkVersion: string\n): boolean {\n  if (!expJson.sdkVersion) {\n    return false;\n  }\n\n  if (expJson.sdkVersion === 'UNVERSIONED') {\n    return true;\n  }\n\n  try {\n    return semver.gte(expJson.sdkVersion, sdkVersion);\n  } catch (e) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${expJson.sdkVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n}\n\nexport function lteSdkVersion(\n  expJson: Pick<ExpoConfig, 'sdkVersion'>,\n  sdkVersion: string\n): boolean {\n  if (!expJson.sdkVersion) {\n    return false;\n  }\n\n  if (expJson.sdkVersion === 'UNVERSIONED') {\n    return false;\n  }\n\n  try {\n    return semver.lte(expJson.sdkVersion, sdkVersion);\n  } catch (e) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${expJson.sdkVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n}\n\nexport function parseSdkVersionFromTag(tag: string): string {\n  if (tag.startsWith('sdk-')) {\n    return tag.substring(4);\n  }\n\n  return tag;\n}\n\n// NOTE(brentvatne): it is possible for an unreleased version to be published to\n// the versions endpoint, but in some cases we need to get the latest *released*\n// version, not just the latest version.\nexport async function newestReleasedSdkVersionAsync(): Promise<{\n  version: string;\n  data: SDKVersion | null;\n}> {\n  const betaOptInEnabled = getenv.boolish('EXPO_BETA', false);\n  const sdkVersions = await sdkVersionsAsync();\n\n  let result = null;\n  let highestMajorVersion = '0.0.0';\n\n  for (const [version, data] of Object.entries(sdkVersions)) {\n    const hasReleaseNotes = !!data.releaseNoteUrl;\n    const isBeta = !!data.beta;\n\n    if (\n      semver.major(version) > semver.major(highestMajorVersion) &&\n      (hasReleaseNotes || (isBeta && betaOptInEnabled))\n    ) {\n      highestMajorVersion = version;\n      result = data;\n    }\n  }\n  return {\n    version: highestMajorVersion,\n    data: result,\n  };\n}\n\n/**\n * Be careful when using this! It can include unreleased and beta SDK versions.\n */\nexport async function newestSdkVersionAsync(): Promise<{\n  version: string;\n  data: SDKVersion | null;\n}> {\n  const sdkVersions = await sdkVersionsAsync();\n  let result = null;\n  let highestMajorVersion = '0.0.0';\n  for (const [version, data] of Object.entries(sdkVersions)) {\n    if (semver.major(version) > semver.major(highestMajorVersion)) {\n      highestMajorVersion = version;\n      result = data;\n    }\n  }\n  return {\n    version: highestMajorVersion,\n    data: result,\n  };\n}\n\nexport async function oldestSupportedMajorVersionAsync(): Promise<number> {\n  const sdkVersions = await sdkVersionsAsync();\n  const supportedVersions = pickBy(sdkVersions, v => !v.isDeprecated);\n  const versionNumbers = Object.keys(supportedVersions).map(version => semver.major(version));\n  return Math.min(...versionNumbers);\n}\n\nexport async function facebookReactNativeVersionsAsync(): Promise<string[]> {\n  const sdkVersions = await sdkVersionsAsync();\n  const facebookReactNativeVersions = new Set(\n    Object.values(sdkVersions)\n      .map(data => data.facebookReactNativeVersion)\n      .filter(version => version)\n  );\n  return Array.from(facebookReactNativeVersions);\n}\n\nexport async function facebookReactNativeVersionToExpoVersionAsync(\n  outerFacebookReactNativeVersion: string\n): Promise<string | null> {\n  if (!semver.valid(outerFacebookReactNativeVersion)) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${outerFacebookReactNativeVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n\n  const sdkVersions = await sdkVersionsAsync();\n  let currentSdkVersion: string | null = null;\n\n  for (const [version, { facebookReactNativeVersion }] of Object.entries(sdkVersions)) {\n    if (\n      semver.major(outerFacebookReactNativeVersion) === semver.major(facebookReactNativeVersion) &&\n      semver.minor(outerFacebookReactNativeVersion) === semver.minor(facebookReactNativeVersion) &&\n      (!currentSdkVersion || semver.gt(version, currentSdkVersion))\n    ) {\n      currentSdkVersion = version;\n    }\n  }\n\n  return currentSdkVersion;\n}\n\nexport async function canTurtleBuildSdkVersion(\n  sdkVersion: string,\n  platform: keyof TurtleSDKVersions\n): Promise<boolean> {\n  if (sdkVersion === 'UNVERSIONED') {\n    return true;\n  }\n\n  if (semver.valid(sdkVersion) == null) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `\"${sdkVersion}\" is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n\n  const supportedVersions = await getSdkVersionsSupportedByTurtle();\n  const supportedVersionsForPlatform: string[] = supportedVersions[platform] ?? [];\n  return supportedVersionsForPlatform.indexOf(sdkVersion) !== -1;\n}\n\nasync function getSdkVersionsSupportedByTurtle(): Promise<TurtleSDKVersions> {\n  const api = new ApiV2Client();\n  return await api.getAsync('standalone-build/supportedSDKVersions');\n}\n"],"file":"../Versions.js","sourceRoot":"/@expo/xdl@59.0.13/src"}