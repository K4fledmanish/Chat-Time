{"version":3,"sources":["../src/accounts.ts"],"names":["UserManager","initialize","UserSecondFactorDeviceMethod","loginOrRegisterAsync","log","warn","program","nonInteractive","CommandError","name","question","type","message","choices","title","value","action","register","login","loginOrRegisterIfLoggedOutAsync","user","getCurrentUserOnlyAsync","options","getCurrentUserAsync","accessToken","parent","chalk","green","username","_usernamePasswordAuth","password","otp","process","env","EXPO_CLI_PASSWORD","_promptForOTPAsync","cancelBehavior","enterMessage","bold","otpQuestion","_promptForBackupOTPAsync","secondFactorDevices","nonPrimarySecondFactorDevices","filter","device","is_primary","length","hasAuthenticatorSecondFactorDevice","find","method","AUTHENTICATOR","smsNonPrimarySecondFactorDevices","SMS","authenticatorChoiceSentinel","cancelChoiceSentinel","deviceChoices","map","idx","sms_phone_number","push","selectedValue","apiAnonymous","ApiV2","clientForUser","postAsync","secondFactorDeviceID","id","_retryUsernamePasswordAuthWithOTPAsync","metadata","smsAutomaticallySent","undefined","primaryDevice","nested","loginAsync","questions","format","val","trim","validate","nonEmptyInput","answers","data","e","ApiV2Error","code","Error","passwordInput","registeredUser","registerAsync","cyan"],"mappings":"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","sourcesContent":["import { ApiV2, RegistrationData, User, UserManager } from '@expo/xdl';\nimport { ApiV2Error } from '@expo/xdl/build/ApiV2';\nimport chalk from 'chalk';\nimport program from 'commander';\n\nimport CommandError from './CommandError';\nimport { assert } from './assert';\nimport log from './log';\nimport promptNew, { confirmAsync, Question as NewQuestion, selectAsync } from './prompts';\nimport { nonEmptyInput } from './validators';\n\nUserManager.initialize();\n\ntype CommandOptions = {\n  username?: string;\n  password?: string;\n  otp?: string;\n  parent?: {\n    nonInteractive: boolean;\n  };\n};\n\nexport enum UserSecondFactorDeviceMethod {\n  AUTHENTICATOR = 'authenticator',\n  SMS = 'sms',\n}\n\nexport type SecondFactorDevice = {\n  id: string;\n  method: UserSecondFactorDeviceMethod;\n  sms_phone_number: string | null;\n  is_primary: boolean;\n};\n\nexport async function loginOrRegisterAsync(): Promise<User> {\n  log.warn('An Expo user account is required to proceed.');\n\n  if (program.nonInteractive) {\n    throw new CommandError(\n      'NOT_LOGGED_IN',\n      `Not logged in. Use \\`${program.name()} login -u username -p password\\` to log in.`\n    );\n  }\n\n  const question: NewQuestion = {\n    type: 'select',\n    name: 'action',\n    message: 'How would you like to authenticate?',\n    choices: [\n      {\n        title: 'Make a new Expo account',\n        value: 'register',\n      },\n      {\n        title: 'Log in with an existing Expo account',\n        value: 'existingUser',\n      },\n      {\n        title: 'Cancel',\n        value: 'cancel',\n      },\n    ],\n  };\n\n  const { action } = await promptNew(question);\n\n  if (action === 'register') {\n    return register();\n  } else if (action === 'existingUser') {\n    return login({});\n  } else {\n    throw new CommandError('BAD_CHOICE', 'Not logged in.');\n  }\n}\n\nexport async function loginOrRegisterIfLoggedOutAsync(): Promise<User> {\n  const user = await UserManager.getCurrentUserOnlyAsync();\n  if (user) {\n    return user;\n  }\n  return await loginOrRegisterAsync();\n}\n\nexport async function login(options: CommandOptions): Promise<User> {\n  const user = await UserManager.getCurrentUserAsync();\n  if (user?.accessToken) {\n    throw new CommandError(\n      'ACCESS_TOKEN_ERROR',\n      'Please remove the EXPO_TOKEN environment var to login with a different user.'\n    );\n  }\n\n  const nonInteractive = options.parent && options.parent.nonInteractive;\n  if (!nonInteractive) {\n    if (user) {\n      const action = await confirmAsync({\n        message: `You are already logged in as ${chalk.green(user.username)}. Log in as new user?`,\n      });\n      if (!action) {\n        // If user chooses to stay logged in, return\n        return user as User;\n      }\n    }\n    return _usernamePasswordAuth(options.username, options.password, options.otp);\n  } else if (options.username && options.password) {\n    return _usernamePasswordAuth(options.username, options.password, options.otp);\n  } else if (options.username && process.env.EXPO_CLI_PASSWORD) {\n    return _usernamePasswordAuth(options.username, process.env.EXPO_CLI_PASSWORD, options.otp);\n  } else {\n    throw new CommandError(\n      'NON_INTERACTIVE',\n      \"Username and password not provided in non-interactive mode. Set the EXPO_CLI_PASSWORD environment variable if you don't want to pass in passwords through the command line.\"\n    );\n  }\n}\n\n/**\n * Prompt for an OTP with the option to cancel the question by answering empty (pressing return key).\n */\nasync function _promptForOTPAsync(cancelBehavior: 'cancel' | 'menu'): Promise<string | null> {\n  const enterMessage =\n    cancelBehavior === 'cancel'\n      ? `press ${log.chalk.bold('Enter')} to cancel`\n      : `press ${log.chalk.bold('Enter')} for more options`;\n  const otpQuestion: NewQuestion = {\n    type: 'text',\n    name: 'otp',\n    message: `One-time password or backup code (${enterMessage}):`,\n  };\n\n  const { otp } = await promptNew(otpQuestion);\n  if (!otp) {\n    return null;\n  }\n\n  return otp;\n}\n\n/**\n * Prompt for user to choose a backup OTP method. If selected method is SMS, a request\n * for a new OTP will be sent to that method. Then, prompt for the OTP, and retry the user login.\n */\nasync function _promptForBackupOTPAsync(\n  username: string,\n  password: string,\n  secondFactorDevices: SecondFactorDevice[]\n): Promise<string | null> {\n  const nonPrimarySecondFactorDevices = secondFactorDevices.filter(device => !device.is_primary);\n\n  if (nonPrimarySecondFactorDevices.length === 0) {\n    throw new CommandError(\n      'LOGIN_CANCELLED',\n      'No other second-factor devices set up. Ensure you have set up and certified a backup device.'\n    );\n  }\n\n  const hasAuthenticatorSecondFactorDevice = nonPrimarySecondFactorDevices.find(\n    device => device.method === UserSecondFactorDeviceMethod.AUTHENTICATOR\n  );\n\n  const smsNonPrimarySecondFactorDevices = nonPrimarySecondFactorDevices.filter(\n    device => device.method === UserSecondFactorDeviceMethod.SMS\n  );\n\n  const authenticatorChoiceSentinel = -1;\n  const cancelChoiceSentinel = -2;\n\n  const deviceChoices = smsNonPrimarySecondFactorDevices.map((device, idx) => ({\n    title: device.sms_phone_number!,\n    value: idx,\n  }));\n\n  if (hasAuthenticatorSecondFactorDevice) {\n    deviceChoices.push({\n      title: 'Authenticator',\n      value: authenticatorChoiceSentinel,\n    });\n  }\n\n  deviceChoices.push({\n    title: 'Cancel',\n    value: cancelChoiceSentinel,\n  });\n\n  const question = {\n    message: 'Select a second-factor device:',\n    choices: deviceChoices,\n  };\n\n  const selectedValue = await selectAsync(question);\n  if (selectedValue === cancelChoiceSentinel) {\n    return null;\n  } else if (selectedValue === authenticatorChoiceSentinel) {\n    return await _promptForOTPAsync('cancel');\n  }\n\n  const device = smsNonPrimarySecondFactorDevices[selectedValue];\n\n  const apiAnonymous = ApiV2.clientForUser();\n  await apiAnonymous.postAsync('auth/send-sms-otp', {\n    username,\n    password,\n    secondFactorDeviceID: device.id,\n  });\n\n  return await _promptForOTPAsync('cancel');\n}\n\n/**\n * Handle the special case error indicating that a second-factor is required for\n * authentication.\n *\n * There are three cases we need to handle:\n * 1. User's primary second-factor device was SMS, OTP was automatically sent by the server to that\n *    device already. In this case we should just prompt for the SMS OTP (or backup code), which the\n *    user should be receiving shortly. We should give the user a way to cancel and the prompt and move\n *    to case 3 below.\n * 2. User's primary second-factor device is authenticator. In this case we should prompt for authenticator\n *    OTP (or backup code) and also give the user a way to cancel and move to case 3 below.\n * 3. User doesn't have a primary device or doesn't have access to their primary device. In this case\n *    we should show a picker of the SMS devices that they can have an OTP code sent to, and when\n *    the user picks one we show a prompt() for the sent OTP.\n */\nexport async function _retryUsernamePasswordAuthWithOTPAsync(\n  username: string,\n  password: string,\n  metadata: {\n    secondFactorDevices?: SecondFactorDevice[];\n    smsAutomaticallySent?: boolean;\n  }\n): Promise<User> {\n  const { secondFactorDevices, smsAutomaticallySent } = metadata;\n  assert(\n    secondFactorDevices !== undefined && smsAutomaticallySent !== undefined,\n    `Malformed OTP error metadata: ${metadata}`\n  );\n\n  const primaryDevice = secondFactorDevices.find(device => device.is_primary);\n  let otp: string | null = null;\n\n  if (smsAutomaticallySent) {\n    assert(primaryDevice, 'OTP should only automatically be sent when there is a primary device');\n    log.nested(\n      `One-time password was sent to the phone number ending in ${primaryDevice.sms_phone_number}.`\n    );\n    otp = await _promptForOTPAsync('menu');\n  }\n\n  if (primaryDevice?.method === UserSecondFactorDeviceMethod.AUTHENTICATOR) {\n    log.nested('One-time password from authenticator required.');\n    otp = await _promptForOTPAsync('menu');\n  }\n\n  // user bailed on case 1 or 2, wants to move to case 3\n  if (!otp) {\n    otp = await _promptForBackupOTPAsync(username, password, secondFactorDevices);\n  }\n\n  if (!otp) {\n    throw new CommandError('LOGIN_CANCELLED', 'Cancelled login');\n  }\n\n  return await UserManager.loginAsync('user-pass', {\n    username,\n    password,\n    otp,\n  });\n}\n\nasync function _usernamePasswordAuth(\n  username?: string,\n  password?: string,\n  otp?: string\n): Promise<User> {\n  const questions: NewQuestion[] = [];\n  if (!username) {\n    questions.push({\n      type: 'text',\n      name: 'username',\n      message: 'Username/Email Address:',\n      format: val => val.trim(),\n      validate: nonEmptyInput,\n    });\n  }\n\n  if (!password) {\n    questions.push({\n      type: 'password',\n      name: 'password',\n      message: 'Password:',\n      format: val => val.trim(),\n      validate: nonEmptyInput,\n    });\n  }\n\n  const answers = await promptNew(questions);\n\n  const data = {\n    username: username || answers.username,\n    password: password || answers.password,\n    otp: otp || answers.otp,\n  };\n\n  let user: User;\n  try {\n    user = await UserManager.loginAsync('user-pass', data);\n  } catch (e) {\n    if (e instanceof ApiV2Error && e.code === 'ONE_TIME_PASSWORD_REQUIRED') {\n      user = await _retryUsernamePasswordAuthWithOTPAsync(\n        data.username,\n        data.password,\n        e.metadata as any\n      );\n    } else {\n      throw e;\n    }\n  }\n\n  if (user) {\n    log(`\\nSuccess. You are now logged in as ${chalk.green(user.username)}.`);\n    return user;\n  } else {\n    throw new Error('Unexpected Error: No user returned from the API');\n  }\n}\n\nexport async function register(): Promise<User> {\n  const user = await UserManager.getCurrentUserAsync();\n  if (user?.accessToken) {\n    throw new CommandError(\n      'ACCESS_TOKEN_ERROR',\n      'Please remove the EXPO_TOKEN environment var to register as a new user.'\n    );\n  }\n\n  log(\n    `\nWe need an email, username, and password to create an account for you.\n`\n  );\n\n  // Answers from previous questions aren't threaded through with `prompts`, so\n  // in order to confirm the password we need to save off the password value\n  // during the initial password validation callback and then validate against\n  // it in the confirmation step.\n  //\n  // https://github.com/expo/expo-cli/issues/2970\n  //\n  let passwordInput: string | undefined;\n\n  const questions: NewQuestion[] = [\n    {\n      type: 'text',\n      name: 'email',\n      message: 'Email:',\n      format: val => val.trim(),\n      validate: nonEmptyInput,\n    },\n    {\n      type: 'text',\n      name: 'username',\n      message: 'Username:',\n      format: val => val.trim(),\n      validate: nonEmptyInput,\n    },\n    {\n      type: 'password',\n      name: 'password',\n      message: 'Password:',\n      format: val => val.trim(),\n      validate(val) {\n        if (val.trim() === '') {\n          return 'Please create a password';\n        }\n\n        passwordInput = val;\n        return true;\n      },\n    },\n    {\n      type: 'password',\n      name: 'passwordRepeat',\n      message: 'Confirm Password:',\n      format: val => val.trim(),\n      validate(val) {\n        if (val.trim() === '') {\n          return false;\n        }\n        if (!passwordInput || val.trim() !== passwordInput.trim()) {\n          return `Passwords don't match!`;\n        }\n        return true;\n      },\n    },\n  ];\n  const answers = await promptNew(questions);\n  const registeredUser = await UserManager.registerAsync(answers as RegistrationData);\n  log(`\\nAccount registered, you are now logged in as ${chalk.cyan(answers.username)}.`);\n  log(\n    `- You can log in to your account on ${chalk.bold(\n      'https://expo.io'\n    )} to manage and collaborate on your projects.`\n  );\n  log(`- You can log in on the Expo client app for quick access to your projects.\\n`);\n  return registeredUser;\n}\n"],"file":"accounts.js"}