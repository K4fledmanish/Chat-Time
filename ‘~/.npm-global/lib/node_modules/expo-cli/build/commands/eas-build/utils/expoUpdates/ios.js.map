{"version":3,"sources":["../../../../../src/commands/eas-build/utils/expoUpdates/ios.ts"],"names":["configureUpdatesAsync","projectDir","exp","username","xcodeProject","IOSConfig","XcodeUtils","getPbxproj","Updates","isShellScriptBuildPhaseConfigured","ensureBundleReactNativePhaseContainsConfigurationScript","fs","writeFile","Paths","getPBXProjectPath","writeSync","expoPlist","readExpoPlistAsync","isPlistConfigurationSynced","setUpdatesConfig","writeExpoPlistAsync","syncUpdatesConfigurationAsync","ensureUpdatesConfiguredAsync","error","log","isPlistVersionConfigurationSynced","setVersionsConfig","warn","script","buildPhase","Error","isPlistConfigurationSet","expoPlistPath","getExpoPlistPath","pathExists","expoPlistContent","readFile","plist","parse","build","mkdirp","path","dirname","intentToAdd"],"mappings":"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","sourcesContent":["import { IOSConfig } from '@expo/config-plugins';\nimport { ExpoConfig } from '@expo/config-types';\nimport plist from '@expo/plist';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { gitAddAsync } from '../../../../git';\nimport log from '../../../../log';\nimport { ensureValidVersions, getAccountName } from './common';\n\nexport async function configureUpdatesAsync(projectDir: string, exp: ExpoConfig): Promise<void> {\n  ensureValidVersions(exp);\n  const username = await getAccountName(exp);\n  let xcodeProject = IOSConfig.XcodeUtils.getPbxproj(projectDir);\n\n  if (!IOSConfig.Updates.isShellScriptBuildPhaseConfigured(projectDir, exp, xcodeProject)) {\n    xcodeProject = IOSConfig.Updates.ensureBundleReactNativePhaseContainsConfigurationScript(\n      projectDir,\n      exp,\n      xcodeProject\n    );\n    await fs.writeFile(IOSConfig.Paths.getPBXProjectPath(projectDir), xcodeProject.writeSync());\n  }\n\n  let expoPlist = await readExpoPlistAsync(projectDir);\n  if (!IOSConfig.Updates.isPlistConfigurationSynced(exp, expoPlist, username)) {\n    expoPlist = IOSConfig.Updates.setUpdatesConfig(exp, expoPlist, username);\n    await writeExpoPlistAsync(projectDir, expoPlist);\n  }\n  // TODO: ensure ExpoPlist in pbxproj\n}\n\nexport async function syncUpdatesConfigurationAsync(\n  projectDir: string,\n  exp: ExpoConfig\n): Promise<void> {\n  ensureValidVersions(exp);\n  const username = await getAccountName(exp);\n  try {\n    await ensureUpdatesConfiguredAsync(projectDir, exp);\n  } catch (error) {\n    log.error(\n      'expo-updates module is not configured. Please run \"expo eas:build:init\" first to configure the project'\n    );\n    throw error;\n  }\n\n  let expoPlist = await readExpoPlistAsync(projectDir);\n  if (!IOSConfig.Updates.isPlistVersionConfigurationSynced(exp, expoPlist)) {\n    expoPlist = IOSConfig.Updates.setVersionsConfig(exp, expoPlist);\n    await writeExpoPlistAsync(projectDir, expoPlist);\n  }\n\n  if (!IOSConfig.Updates.isPlistConfigurationSynced(exp, expoPlist, username)) {\n    log.warn(\n      'Native project configuration is not synced with values present in you app.json, run expo eas:build:init to make sure all values are applied in antive project'\n    );\n  }\n}\n\nexport async function ensureUpdatesConfiguredAsync(\n  projectDir: string,\n  exp: ExpoConfig\n): Promise<void> {\n  const xcodeProject = IOSConfig.XcodeUtils.getPbxproj(projectDir);\n\n  if (!IOSConfig.Updates.isShellScriptBuildPhaseConfigured(projectDir, exp, xcodeProject)) {\n    const script = 'expo-updates/scripts/create-manifest-ios.sh';\n    const buildPhase = '\"Bundle React Native code and images\"';\n    throw new Error(`Path to ${script} is missing in a ${buildPhase} build phase.`);\n  }\n\n  const expoPlist = await readExpoPlistAsync(projectDir);\n  if (!IOSConfig.Updates.isPlistConfigurationSet(expoPlist)) {\n    throw new Error('Missing values in Expo.plist');\n  }\n}\n\nasync function readExpoPlistAsync(projectDir: string): Promise<IOSConfig.ExpoPlist> {\n  const expoPlistPath = IOSConfig.Paths.getExpoPlistPath(projectDir);\n\n  let expoPlist = {};\n  if (await fs.pathExists(expoPlistPath)) {\n    const expoPlistContent = await fs.readFile(expoPlistPath, 'utf8');\n    expoPlist = plist.parse(expoPlistContent);\n  }\n  return expoPlist;\n}\n\nasync function writeExpoPlistAsync(\n  projectDir: string,\n  expoPlist: IOSConfig.ExpoPlist\n): Promise<void> {\n  const expoPlistPath = IOSConfig.Paths.getExpoPlistPath(projectDir);\n  const expoPlistContent = plist.build(expoPlist);\n\n  await fs.mkdirp(path.dirname(expoPlistPath));\n  await fs.writeFile(expoPlistPath, expoPlistContent);\n  await gitAddAsync(expoPlistPath, { intentToAdd: true });\n}\n"],"file":"ios.js"}